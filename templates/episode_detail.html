{% extends "base.html" %} {% block title %}{{ episode.title }} - Journal Entry - Charlie{%
endblock %} {% block content %}
<div class="episode-detail-page">
    <header class="page-header">
        <nav class="breadcrumb">
            <a href="/">Home</a> → <a href="/">Journal Entries</a> →
            <span>{{ episode.title[:50] }}{% if episode.title|length > 50 %}...{% endif %}</span>
        </nav>
    </header>

    <div class="episode-detail">
        <article class="episode-content">
            <header class="episode-header">
                <time
                    class="episode-date"
                    datetime="{{ episode.valid_at.isoformat() }}"
                >
                    {{ episode.display_date }}
                </time>
            </header>

        <div class="episode-body markdown-content">
            {{ enriched_content | safe }}
        </div>

        <footer class="episode-footer">
            <a href="/" class="button-link">&larr; Back to Journal Entries</a>
        </footer>
        </article>

        <aside class="episode-sidebar">
            <div class="entities-panel">
                <h2 id="facts-heading">Facts</h2>
                <p class="helper-text" id="facts-helper">Hover over highlighted entities to view related facts</p>
                <ul class="relationships-list" id="facts-list" style="display: none;">
                </ul>
            </div>
        </aside>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    // Relationship data grouped by entity UUID
    const relationshipsByEntity = {{ relationships_by_entity | tojson | safe }} || {};
    console.log("Relationships by entity:", relationshipsByEntity);

    document.addEventListener("DOMContentLoaded", function () {
        const mentions = document.querySelectorAll(".entity-mention");
        const factsHelper = document.getElementById("facts-helper");
        const factsList = document.getElementById("facts-list");
        const factsHeading = document.getElementById("facts-heading");

        console.log("Found entity mentions:", mentions.length);

        mentions.forEach((mention) => {
            const entityUuid = mention.dataset.entityUuid;
            const entityName = mention.dataset.entityName;
            const entitySummary = mention.dataset.entitySummary;

            console.log("Processing entity:", entityName, entityUuid);

            // Add "has-facts" class if this entity has relationships
            const relationships = relationshipsByEntity[entityUuid];
            console.log("Relationships for", entityName, ":", relationships);
            if (relationships && relationships.length > 0) {
                mention.classList.add("has-facts");
                console.log("✓ Added has-facts class to:", entityName, "(" + relationships.length + " facts)");
            } else {
                console.log("✗ No facts for:", entityName);
            }

            // Make clickable
            mention.style.cursor = "pointer";
            mention.addEventListener("click", function (e) {
                e.preventDefault();
                window.location.href = `/entities/${entityUuid}`;
            });

            // Show tooltip on hover
            mention.setAttribute("title", `${entityName}: ${entitySummary}`);

            // Populate sidebar with relationship facts on hover
            mention.addEventListener("mouseenter", function () {
                const relationships = relationshipsByEntity[entityUuid];

                if (relationships && relationships.length > 0) {
                    // Hide heading and helper text, show facts list
                    factsHeading.style.display = "none";
                    factsHelper.style.display = "none";
                    factsList.style.display = "block";

                    // Clear existing content
                    factsList.innerHTML = "";

                    // Populate with relationships
                    relationships.forEach((rel) => {
                        const li = document.createElement("li");
                        li.className = "relationship-item";

                        if (rel.relationship_fact) {
                            const fact = document.createElement("span");
                            fact.className = "relationship-fact";
                            fact.innerHTML = rel.relationship_fact;
                            li.appendChild(fact);
                        }

                        factsList.appendChild(li);
                    });
                }
                // Note: Removed the "no facts" message and removed all mouseleave handlers
                // Facts now persist until you hover over another entity with facts
            });
        });
    });
</script>
{% endblock %}
